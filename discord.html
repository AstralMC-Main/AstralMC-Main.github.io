<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstralMC Discord Widget</title>
<style>
body { font-family: sans-serif; background: #2f3136; color: #fff; margin: 0; display: flex; height: 100vh; }
#sidebar { width: 250px; background: #202225; padding: 10px; box-sizing: border-box; overflow-y: auto; }
#content { flex: 1; padding: 10px; display: flex; flex-direction: column; }
button { margin: 5px 0; padding: 10px; border: none; border-radius: 8px; cursor: pointer; }
#loginBtn { background: #5865f2; color: #fff; }
#logoutBtn { background: #f04747; color: #fff; display: none; }
#user { margin-bottom: 10px; }
#servers div { margin-bottom: 5px; }
#chat { flex: 1; overflow-y: auto; background: #36393f; padding: 10px; border-radius: 8px; }
#messageInput { margin-top: 10px; padding: 8px; border-radius: 8px; border: none; width: 100%; }
</style>
</head>
<body>

<div id="sidebar">
    <div id="user"></div>
    <button id="loginBtn">Login with Discord</button>
    <button id="logoutBtn">Logout</button>
    <div id="servers"></div>
</div>

<div id="content">
    <div id="chat"></div>
    <input id="messageInput" placeholder="Type a message..." />
</div>

<script>
const backendURL = "http://started-gel.gl.at.ply.gg:38956";
let currentChannelId = null;
let chatInterval = null;

// --- Check login status ---
async function checkLogin() {
    try {
        const res = await fetch(`${backendURL}/me`, {
            credentials: "include"
        });
        if (res.status === 200) {
            const user = await res.json();
            document.getElementById("user").textContent = `Logged in as ${user.username}#${user.discriminator}`;
            document.getElementById("loginBtn").style.display = "none";
            document.getElementById("logoutBtn").style.display = "inline-block";
            loadGuilds();
        } else {
            document.getElementById("user").textContent = "";
            document.getElementById("loginBtn").style.display = "inline-block";
            document.getElementById("logoutBtn").style.display = "none";
        }
    } catch(e) {
        console.error(e);
    }
}

// Call on page load
checkLogin();

// Login button
document.getElementById("loginBtn").onclick = () => {
    window.location.href = `${backendURL}/login`;
};

// Logout button
document.getElementById("logoutBtn").onclick = async () => {
    await fetch(`${backendURL}/logout`, {
        method: "POST",
        credentials: "include"
    });
    document.getElementById("user").textContent = "";
    document.getElementById("loginBtn").style.display = "inline-block";
    document.getElementById("logoutBtn").style.display = "none";
    document.getElementById("servers").innerHTML = "";
    document.getElementById("chat").innerHTML = "";
};

// Load user's guilds
async function loadGuilds() {
    try {
        const res = await fetch('https://discord.com/api/users/@me/guilds', {
            credentials: "include",
            headers: {
                Authorization: `Bearer ${await getToken()}`
            }
        });
        const guilds = await res.json();
        const serversDiv = document.getElementById("servers");
        serversDiv.innerHTML = "";
        guilds.forEach(g => {
            const btn = document.createElement("button");
            btn.textContent = g.name;
            btn.onclick = () => loadChannels(g.id);
            serversDiv.appendChild(btn);
        });
    } catch(e) { console.error(e); }
}

// Helper: get token from backend via /me (cookie)
async function getToken() {
    // The backend already has it in a cookie; you can optionally return it here
    // or just rely on Authorization cookie if the backend supports it
    return ""; // empty string if using cookie-based auth
}

// Load channels for selected guild
async function loadChannels(guildId) {
    try {
        const res = await fetch(`https://discord.com/api/guilds/${guildId}/channels`, {
            headers: { Authorization: `Bearer ${await getToken()}` }
        });
        const channels = await res.json();
        const serversDiv = document.getElementById("servers");
        const oldChannels = document.getElementById("channels");
        if(oldChannels) oldChannels.remove();

        const channelDiv = document.createElement("div");
        channelDiv.id = "channels";
        channels.forEach(c => {
            if(c.type===0){ // text channel
                const chBtn = document.createElement("button");
                chBtn.textContent = c.name;
                chBtn.onclick = () => loadMessages(guildId, c.id);
                channelDiv.appendChild(chBtn);
            }
        });
        serversDiv.appendChild(channelDiv);
    } catch(e){console.error(e);}
}

// Load messages
async function loadMessages(guildId, channelId){
    currentChannelId = channelId;
    if(chatInterval) clearInterval(chatInterval);

    async function fetchMessages() {
        try{
            const res = await fetch(`https://discord.com/api/channels/${currentChannelId}/messages?limit=20`, {
                headers:{ Authorization:`Bearer ${await getToken()}` }
            });
            const messages = await res.json();
            const chatDiv = document.getElementById("chat");
            chatDiv.innerHTML = "";
            messages.reverse().forEach(m => {
                const msgDiv = document.createElement("div");
                msgDiv.textContent = `${m.author.username}: ${m.content}`;
                chatDiv.appendChild(msgDiv);
            });
        } catch(e){console.error(e);}
    }

    fetchMessages();
    chatInterval = setInterval(fetchMessages, 5000);
}

// Sending messages (placeholder)
document.getElementById("messageInput").addEventListener("keydown", async e => {
    if(e.key==="Enter"){
        e.target.value = "";
        // actual sending requires bot or backend endpoint
    }
});

</script>
</body>
</html>
