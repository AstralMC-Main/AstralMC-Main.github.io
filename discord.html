<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AstralMC Discord Widget</title>
  <style>
    body { font-family: sans-serif; display: flex; margin: 0; height: 100vh; }
    #sidebar { background: #2c2f33; color: white; padding: 10px; width: 200px; overflow-y: auto; }
    #channels { background: #23272a; color: white; padding: 10px; width: 200px; overflow-y: auto; }
    #chat { flex: 1; display: flex; flex-direction: column; background: #36393f; }
    #messages { flex: 1; overflow-y: auto; padding: 10px; color: white; }
    #messageInput { display: flex; }
    #messageInput input { flex: 1; padding: 5px; }
    #messageInput button { padding: 5px; }
    button { cursor: pointer; margin-top: 5px; }
  </style>
</head>
<body>

<div id="sidebar">
  <div id="userInfo"></div>
  <button id="loginBtn">Login with Discord</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
  <h3>Servers</h3>
  <div id="guildList"></div>
</div>

<div id="channels">
  <h3>Channels</h3>
  <div id="channelList"></div>
</div>

<div id="chat">
  <div id="messages"></div>
  <div id="messageInput">
    <input type="text" id="msgText" placeholder="Type a message..." />
    <button id="sendMsg">Send</button>
  </div>
</div>

<script>
const backendURL = "http://started-gel.gl.at.ply.gg:38956"; // Playit public URL
let selectedGuild = null;
let selectedChannel = null;
let ws = null;

const userInfo = document.getElementById('userInfo');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const guildList = document.getElementById('guildList');
const channelList = document.getElementById('channelList');
const messagesDiv = document.getElementById('messages');
const msgText = document.getElementById('msgText');
const sendMsg = document.getElementById('sendMsg');

async function checkLogin() {
  let res = await fetch(`${backendURL}/me`, { credentials: 'include' });
  if (res.ok) {
    let user = await res.json();
    userInfo.innerHTML = `
      <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" width="40" style="border-radius:50%;" />
      <span>${user.username}#${user.discriminator}</span>
    `;
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'block';
    loadGuilds();
    connectWS();
  } else {
    loginBtn.style.display = 'block';
    logoutBtn.style.display = 'none';
  }
}

async function loadGuilds() {
  let res = await fetch(`${backendURL}/mutualGuilds`, { credentials: 'include' });
  let guilds = await res.json();
  guildList.innerHTML = '';
  guilds.forEach(g => {
    let btn = document.createElement('button');
    btn.textContent = g.name;
    btn.onclick = () => {
      selectedGuild = g.id;
      loadChannels(g.id);
    };
    guildList.appendChild(btn);
  });
}

async function loadChannels(guildId) {
  let res = await fetch(`${backendURL}/channels/${guildId}`, { credentials: 'include' });
  let chans = await res.json();
  channelList.innerHTML = '';
  chans.forEach(c => {
    if(c.type !== 0) return; // text channels only
    let btn = document.createElement('button');
    btn.textContent = `#${c.name}`;
    btn.onclick = () => {
      selectedChannel = c.id;
      loadMessages(c.id);
    };
    channelList.appendChild(btn);
  });
}

async function loadMessages(channelId) {
  let res = await fetch(`${backendURL}/messages/${channelId}?limit=50`, { credentials: 'include' });
  let msgs = await res.json();
  messagesDiv.innerHTML = '';
  msgs.forEach(m => addMessage(m));
}

function addMessage(m) {
  let el = document.createElement('div');
  el.textContent = `${m.author.username}: ${m.content}`;
  messagesDiv.appendChild(el);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function connectWS() {
  ws = new WebSocket(backendURL.replace('http','ws') + '/ws');
  ws.onmessage = (ev) => {
    let data = JSON.parse(ev.data);
    if (data.channelId === selectedChannel) addMessage(data);
  };
}

loginBtn.onclick = () => window.location.href = `${backendURL}/login`;
logoutBtn.onclick = async () => {
  await fetch(`${backendURL}/logout`, { method:'POST', credentials:'include' });
  location.reload();
};
sendMsg.onclick = async () => {
  if(!selectedChannel) return;
  let content = msgText.value.trim();
  if(!content) return;
  await fetch(`${backendURL}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    credentials: 'include',
    body: JSON.stringify({ guildId:selectedGuild, channelId:selectedChannel, content })
  });
  msgText.value = '';
};

checkLogin();
</script>

</body>
</html>