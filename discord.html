<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstralMC Discord Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family:sans-serif; margin:0; padding:0; background:#1e1e1e; color:white;}
header { padding:10px; text-align:center;}
select, button, input { padding:8px; margin:5px;}
#chat { width:100%; height:60vh; background:#2e2e2e; overflow:auto; padding:5px; border-radius:6px;}
#input { width:70%; border-radius:4px;}
#send { border-radius:4px;}
#userStatus { margin:5px;color:#0f0; }
</style>
</head>
<body>
<header>
<h1>AstralMC Discord Chat</h1>
<div id="userStatus"></div>
<button id="loginBtn">Login with Discord</button>
<br>
<select id="guildSelect"></select>
<select id="channelSelect"></select>
<br>
<input id="input" placeholder="Message...">
<button id="send">Send</button>
</header>
<div id="chat"></div>

<script>
const BACKEND = "http://started-gel.gl.at.ply.gg:38956"; // Playit.gg URL

// Elements
const loginBtn = document.getElementById("loginBtn");
const userStatus = document.getElementById("userStatus");
const guildSelect = document.getElementById("guildSelect");
const channelSelect = document.getElementById("channelSelect");
const input = document.getElementById("input");
const sendBtn = document.getElementById("send");
const chat = document.getElementById("chat");

// -------------------- Handle OAuth2 callback --------------------
function handleOAuthCallback() {
    if (location.hash.includes("access_token")) {
        const hash = new URLSearchParams(location.hash.slice(1));
        const accessToken = hash.get("access_token");
        if (accessToken) {
            localStorage.setItem("discord_token", accessToken);
            token = accessToken;
            history.replaceState(null, "", location.pathname + location.search);
        }
    }
}
let token = localStorage.getItem("discord_token");
handleOAuthCallback();

// -------------------- UI visibility --------------------
function updateUI() {
    if (token) {
        loginBtn.style.display = "none";
        guildSelect.style.display = "inline-block";
        channelSelect.style.display = "inline-block";
        input.style.display = "inline-block";
        sendBtn.style.display = "inline-block";
    } else {
        loginBtn.style.display = "inline-block";
        guildSelect.style.display = "none";
        channelSelect.style.display = "none";
        input.style.display = "none";
        sendBtn.style.display = "none";
        chat.innerHTML = "";
        userStatus.textContent = "";
    }
}
updateUI();

// -------------------- Login button --------------------
loginBtn.onclick = () => {
    window.location.href = `${BACKEND}/login`;
};

// -------------------- Fetch user info --------------------
async function fetchUserInfo() {
    if (!token) return;
    try {
        const res = await fetch('https://discord.com/api/v10/users/@me', {
            headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Failed to fetch user');
        const user = await res.json();
        userStatus.textContent = `Logged in as ${user.username}#${user.discriminator}`;
    } catch (e) {
        console.error(e);
        userStatus.textContent = `Logged in`;
    }
}

// -------------------- Load mutual guilds --------------------
async function loadGuilds() {
    if(!token) return;
    try {
        const guilds = await fetch(`${BACKEND}/mutualGuilds?token=${token}`).then(r=>r.json());
        guildSelect.innerHTML = "";
        guilds.forEach(g => {
            const opt = document.createElement("option");
            opt.value = g.id;
            opt.textContent = g.name;
            guildSelect.appendChild(opt);
        });
        loadChannels();
    } catch(e) { console.error(e); }
}

// -------------------- Load channels --------------------
async function loadChannels() {
    const gid = guildSelect.value;
    if(!gid) return;
    try {
        const chans = await fetch(`${BACKEND}/channels/${gid}`).then(r=>r.json());
        channelSelect.innerHTML = "";
        chans.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.name;
            channelSelect.appendChild(opt);
        });
        connectWS();
    } catch(e) { console.error(e); }
}
guildSelect.onchange = loadChannels;

// -------------------- WebSocket for live chat --------------------
let ws;
function connectWS() {
    if(ws) ws.close();
    ws = new WebSocket(`${BACKEND.replace(/^http/,"ws")}/ws`);
    ws.onopen = ()=>{
        const guildId = guildSelect.value;
        const channelId = channelSelect.value;
        ws.send(JSON.stringify({guildId,channelId}));
    };
    ws.onmessage = (msg)=>{
        try {
            const data = JSON.parse(msg.data);
            const div = document.createElement("div");
            div.textContent = `${data.author?.username || 'Bot'}: ${data.content}`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        } catch(e){ console.error(e); }
    };
    ws.onclose = ()=> {
        setTimeout(connectWS, 3000); // auto-reconnect
    };
}

// -------------------- Send message --------------------
sendBtn.onclick = async () => {
    const guildId = guildSelect.value;
    const channelId = channelSelect.value;
    const content = input.value;
    if(!content) return;
    try {
        await fetch(`${BACKEND}/sendMessage`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({guildId, channelId, content})
        });
        input.value="";
    } catch(e){console.error(e);}
};

// -------------------- Initialize --------------------
if(token){
    updateUI();
    fetchUserInfo();
    loadGuilds();
}
</script>
</body>
</html>