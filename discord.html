<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AstralMC Discord Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root { --bg:#1e1f22; --bg2:#2b2d31; --panel:#232428; --accent:#5865f2; --text:#eee; --muted:#9ca3af; }
  * { box-sizing: border-box; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial; height:100vh; display:flex; }
  #servers { width:80px; background:#202225; overflow:auto; padding:10px 6px; }
  #channels { width:240px; background:var(--panel); overflow:auto; padding:10px; }
  #main { flex:1; display:flex; flex-direction:column; }
  #topbar { background:var(--bg2); padding:10px 12px; display:flex; align-items:center; gap:10px; justify-content:space-between; border-bottom:1px solid #0006; }
  #status { font-size:14px; color:var(--muted); }
  #messages { flex:1; overflow:auto; padding:12px; }
  #composer { display:flex; gap:8px; padding:10px; background:var(--bg2); border-top:1px solid #0006; }
  #composer input { flex:1; padding:10px; border-radius:8px; border:1px solid #0000; background:#2a2c31; color:var(--text); }
  #composer button, .btn { padding:8px 12px; border-radius:8px; border:none; color:white; background:var(--accent); cursor:pointer; }
  .btn.secondary { background:#3b3d44; }
  .btn:disabled { opacity:.6; cursor:not-allowed; }
  .server { width:56px; height:56px; border-radius:50%; background:#36393f; display:flex; align-items:center; justify-content:center; margin:8px 0; cursor:pointer; border:2px solid transparent; user-select:none; }
  .server.active { border-color:var(--accent); }
  .server img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
  .chan { padding:6px 8px; border-radius:6px; cursor:pointer; color:var(--muted); }
  .chan.active { background:#2f3136; color:var(--text); }
  .msg { margin-bottom:10px; }
  .author { font-weight:600; margin-right:6px; }
  .time { color:var(--muted); font-size:12px; margin-left:6px; }
  #empty { color:var(--muted); padding:12px; }
</style>
</head>
<body>

<div id="servers"></div>
<div id="channels"></div>

<div id="main">
  <div id="topbar">
    <div><span id="status">Not logged in</span></div>
    <div>
      <button id="loginBtn" class="btn">Login</button>
      <button id="logoutBtn" class="btn secondary" style="display:none;">Logout</button>
    </div>
  </div>

  <div id="messages"><div id="empty">Select a channel to start chatting.</div></div>

  <div id="composer">
    <input id="msgInput" placeholder="Type a message..." />
    <button id="sendBtn" class="btn" disabled>Send</button>
  </div>
</div>

<script>
/** IMPORTANT: use HTTPS here (GitHub Pages is https) */
const BACKEND = "https://started-gel.gl.at.ply.gg:38956";

/** WebSocket URL helper */
function wsUrlFromBackend(url) {
  if (url.startsWith("https://")) return url.replace(/^https:\/\//i, "wss://") + "/ws";
  if (url.startsWith("http://"))  return url.replace(/^http:\/\//i,  "ws://")  + "/ws";
  return url + "/ws";
}

let token = null;
let me = null;
let currentGuild = null;
let currentChannel = null;
let ws = null;

const el = (id)=>document.getElementById(id);
const serversEl = el("servers");
const channelsEl = el("channels");
const messagesEl = el("messages");
const statusEl = el("status");
const loginBtn = el("loginBtn");
const logoutBtn = el("logoutBtn");
const msgInput = el("msgInput");
const sendBtn = el("sendBtn");

/* --- OAuth callback from backend: #access_token=... --- */
function handleOAuthCallback(){
  if(location.hash.includes("access_token")){
    const p = new URLSearchParams(location.hash.slice(1));
    const at = p.get("access_token");
    if(at){ localStorage.setItem("discord_token", at); token = at; }
    // Clean URL (removes token fragment)
    history.replaceState(null, "", location.pathname + location.search);
  }
}
token = localStorage.getItem("discord_token");
handleOAuthCallback();

/* --- UI state --- */
function setLoggedOutUI(){
  statusEl.textContent = "Not logged in";
  loginBtn.style.display = "inline-block";
  logoutBtn.style.display = "none";
  sendBtn.disabled = true;
  serversEl.innerHTML = "";
  channelsEl.innerHTML = "";
  messagesEl.innerHTML = '<div id="empty">Select a channel to start chatting.</div>';
  currentGuild = null;
  currentChannel = null;
  if(ws){ try{ ws.close(); }catch(_){} ws = null; }
}
function setLoggedInUI(){
  loginBtn.style.display = "none";
  logoutBtn.style.display = "inline-block";
}

/* --- Buttons --- */
loginBtn.onclick = ()=> window.location.href = `${BACKEND}/login`;
logoutBtn.onclick = ()=>{
  localStorage.removeItem("discord_token");
  token = null; me = null;
  setLoggedOutUI();
};

/* --- Backend helpers (no direct Discord calls in browser) --- */
async function apiMe(){
  const r = await fetch(`${BACKEND}/me?token=${encodeURIComponent(token)}`);
  if(!r.ok) throw new Error("Failed /me");
  return r.json();
}
async function apiGuilds(){
  const r = await fetch(`${BACKEND}/mutualGuilds?token=${encodeURIComponent(token)}`);
  if(!r.ok) throw new Error("Failed /mutualGuilds");
  return r.json();
}
async function apiChannels(guildId){
  const r = await fetch(`${BACKEND}/channels/${guildId}`);
  if(!r.ok) throw new Error("Failed /channels");
  return r.json();
}
async function apiMessages(channelId, limit=50){
  const r = await fetch(`${BACKEND}/messages/${channelId}?limit=${limit}`);
  if(!r.ok) throw new Error("Failed /messages");
  return r.json();
}
async function apiSend(channelId, content){
  const r = await fetch(`${BACKEND}/sendMessage`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ guildId: currentGuild, channelId, content })
  });
  if(!r.ok) throw new Error("Failed /sendMessage");
  return r.json();
}

/* --- Rendering --- */
function renderServers(guilds){
  serversEl.innerHTML = "";
  guilds.forEach(g=>{
    const div = document.createElement("div");
    div.className = "server" + (g.id===currentGuild ? " active":"");
    if(g.icon){
      const img = document.createElement("img");
      const fmt = g.icon.startsWith("a_") ? "gif" : "png";
      img.src = `https://cdn.discordapp.com/icons/${g.id}/${g.icon}.${fmt}?size=64`;
      div.appendChild(img);
    } else {
      div.textContent = (g.name?.[0] || "?").toUpperCase();
    }
    div.title = g.name || "Server";
    div.onclick = async ()=>{
      currentGuild = g.id;
      document.querySelectorAll(".server").forEach(n=>n.classList.remove("active"));
      div.classList.add("active");
      await showChannels(g.id);
    };
    serversEl.appendChild(div);
  });
}
function renderChannels(chans){
  channelsEl.innerHTML = "";
  chans.forEach(c=>{
    if(c.type !== 0) return;
    const row = document.createElement("div");
    row.className = "chan" + (c.id===currentChannel ? " active":"");
    row.textContent = `# ${c.name}`;
    row.onclick = async ()=>{
      document.querySelectorAll(".chan").forEach(n=>n.classList.remove("active"));
      row.classList.add("active");
      await openChannel(c.id);
    };
    channelsEl.appendChild(row);
  });
}
function renderMessages(msgs){
  messagesEl.innerHTML = "";
  if(!Array.isArray(msgs) || !msgs.length){
    messagesEl.innerHTML = '<div id="empty">No messages yet.</div>';
    return;
  }
  msgs.slice().reverse().forEach(m=>{
    const line = document.createElement("div");
    line.className = "msg";
    const author = document.createElement("span"); author.className="author";
    author.textContent = m.author?.username ?? "Unknown";
    const content = document.createElement("span");
    content.textContent = `: ${m.content ?? ""}`;
    const time = document.createElement("span"); time.className="time";
    if(m.timestamp){ time.textContent = "  " + new Date(m.timestamp).toLocaleString(); }
    line.appendChild(author); line.appendChild(content); line.appendChild(time);
    messagesEl.appendChild(line);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* --- Channel ops --- */
async function openChannel(channelId){
  currentChannel = channelId;
  sendBtn.disabled = false;
  try{
    const msgs = await apiMessages(channelId, 50);
    renderMessages(msgs);
  }catch(e){ console.error(e); }
  connectWS();
}
async function showChannels(guildId){
  try{
    const chans = await apiChannels(guildId);
    renderChannels(chans);
    const first = chans.find(c=>c.type===0);
    if(first) await openChannel(first.id);
  }catch(e){ console.error(e); }
}

/* --- WebSocket --- */
function connectWS(){
  if(ws){ try{ ws.close(); }catch(_){} }
  const url = wsUrlFromBackend(BACKEND);
  ws = new WebSocket(url);
  ws.onopen = ()=>{
    if(currentGuild && currentChannel){
      ws.send(JSON.stringify({ guildId: currentGuild, channelId: currentChannel }));
    }
  };
  ws.onmessage = (ev)=>{
    try{
      const data = JSON.parse(ev.data);
      if(data.channel_id && data.channel_id !== currentChannel) return;
      const line = document.createElement("div");
      line.className = "msg";
      const author = document.createElement("span"); author.className="author";
      author.textContent = data.author?.username ?? "Unknown";
      const content = document.createElement("span");
      content.textContent = `: ${data.content ?? ""}`;
      const time = document.createElement("span"); time.className="time";
      if(data.timestamp){ time.textContent = "  " + new Date(data.timestamp).toLocaleString(); }
      line.appendChild(author); line.appendChild(content); line.appendChild(time);
      messagesEl.appendChild(line);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }catch(e){ console.error(e); }
  };
  ws.onclose = ()=> setTimeout(connectWS, 2500);
}

/* --- Send --- */
sendBtn.onclick = async ()=>{
  if(!currentChannel) return;
  const content = msgInput.value.trim();
  if(!content) return;
  msgInput.value = "";
  try{ await apiSend(currentChannel, content); }catch(e){ console.error(e); }
};

/* --- Boot --- */
(async function boot(){
  if(!token){ setLoggedOutUI(); return; }
  try{
    setLoggedInUI();
    me = await apiMe(); // uses backend proxy (no CORS to Discord)
    statusEl.textContent = `Logged in as ${me.username}#${me.discriminator}`;
    const guilds = await apiGuilds();
    if(!guilds.length){
      serversEl.innerHTML = "";
      channelsEl.innerHTML = "";
      messagesEl.innerHTML = '<div id="empty">No mutual servers with the bot.</div>';
      return;
    }
    renderServers(guilds);
    currentGuild = guilds[0].id;
    document.querySelectorAll(".server")[0]?.classList.add("active");
    await showChannels(currentGuild);
  }catch(e){
    console.error(e);
    // likely token invalid or backend blocked by mixed content
    setLoggedOutUI();
  }
})();
</script>
</body>
</html>