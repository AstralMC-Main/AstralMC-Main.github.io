<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstralMC Discord Widget</title>
<style>
body { font-family: sans-serif; background: #2f3136; color: #fff; margin: 0; display: flex; height: 100vh; }
#sidebar { width: 250px; background: #202225; padding: 10px; box-sizing: border-box; overflow-y: auto; }
#content { flex: 1; padding: 10px; display: flex; flex-direction: column; }
button { margin: 5px 0; padding: 10px; border: none; border-radius: 8px; cursor: pointer; }
#loginBtn { background: #5865f2; color: #fff; }
#logoutBtn { background: #f04747; color: #fff; display: none; }
#user { margin-bottom: 10px; }
#servers div { margin-bottom: 5px; }
#chat { flex: 1; overflow-y: auto; background: #36393f; padding: 10px; border-radius: 8px; }
#messageInput { margin-top: 10px; padding: 8px; border-radius: 8px; border: none; width: 100%; }
#resetBtn { position: fixed; bottom: 10px; left: 10px; padding: 5px 10px; font-size: 12px; background: #7289da; border-radius: 5px; color: #fff; border: none; cursor: pointer; }
</style>
</head>
<body>

<div id="sidebar">
    <div id="user"></div>
    <button id="loginBtn">Login with Discord</button>
    <button id="logoutBtn">Logout</button>
    <div id="servers"></div>
</div>

<div id="content">
    <div id="chat"></div>
    <input id="messageInput" placeholder="Type a message..." />
</div>

<button id="resetBtn">Reset Token / Reload</button>

<script>
const backendURL = "http://started-gel.gl.at.ply.gg:38956";
let token = null;
let currentChannelId = null;
let chatInterval = null;

// --- Parse token from URL fragment ---
(function handleOAuthCallback() {
    if(window.location.hash.includes("access_token")) {
        const params = new URLSearchParams(window.location.hash.slice(1));
        token = params.get("access_token");
        if(token) localStorage.setItem("discord_token", token);
        history.replaceState(null, "", window.location.pathname); // clean URL
    } else {
        token = localStorage.getItem("discord_token");
    }
})();

// --- Update UI after login ---
async function updateUI() {
    if(!token) return showLoggedOut();
    try {
        const res = await fetch('https://discord.com/api/users/@me', {
            headers: { Authorization: `Bearer ${token}` }
        });
        if(!res.ok) throw new Error("Invalid token");
        const user = await res.json();
        document.getElementById("user").textContent = `Logged in as ${user.username}#${user.discriminator}`;
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";
        loadGuilds();
    } catch(e){
        console.error(e);
        showLoggedOut();
    }
}

// --- Show logged out state ---
function showLoggedOut() {
    token = null;
    localStorage.removeItem("discord_token");
    document.getElementById("user").textContent = "";
    document.getElementById("loginBtn").style.display = "inline-block";
    document.getElementById("logoutBtn").style.display = "none";
    document.getElementById("servers").innerHTML = "";
    document.getElementById("chat").innerHTML = "";
}

// --- Login / Logout ---
document.getElementById("loginBtn").onclick = () => window.location.href = `${backendURL}/login`;
document.getElementById("logoutBtn").onclick = showLoggedOut;

// --- Reset button for testing ---
document.getElementById("resetBtn").onclick = () => {
    localStorage.removeItem("discord_token");
    location.reload();
};

// --- Load guilds ---
async function loadGuilds() {
    try {
        const res = await fetch('https://discord.com/api/users/@me/guilds', {
            headers: { Authorization: `Bearer ${token}` }
        });
        const guilds = await res.json();
        const serversDiv = document.getElementById("servers");
        serversDiv.innerHTML = "";
        guilds.forEach(g => {
            const btn = document.createElement("button");
            btn.textContent = g.name;
            btn.onclick = () => loadChannels(g.id);
            serversDiv.appendChild(btn);
        });
    } catch(e) { console.error(e); }
}

// --- Load channels ---
async function loadChannels(guildId) {
    try {
        const res = await fetch(`https://discord.com/api/guilds/${guildId}/channels`, {
            headers: { Authorization: `Bearer ${token}` }
        });
        const channels = await res.json();
        const serversDiv = document.getElementById("servers");
        const oldChannels = document.getElementById("channels");
        if(oldChannels) oldChannels.remove();

        const channelDiv = document.createElement("div");
        channelDiv.id = "channels";
        channels.forEach(c => {
            if(c.type===0){
                const chBtn = document.createElement("button");
                chBtn.textContent = c.name;
                chBtn.onclick = () => loadMessages(guildId, c.id);
                channelDiv.appendChild(chBtn);
            }
        });
        serversDiv.appendChild(channelDiv);
    } catch(e){console.error(e);}
}

// --- Load messages ---
async function loadMessages(guildId, channelId){
    currentChannelId = channelId;
    if(chatInterval) clearInterval(chatInterval);

    async function fetchMessages() {
        try {
            const res = await fetch(`https://discord.com/api/channels/${currentChannelId}/messages?limit=20`, {
                headers:{ Authorization:`Bearer ${token}` }
            });
            const messages = await res.json();
            const chatDiv = document.getElementById("chat");
            chatDiv.innerHTML = "";
            messages.reverse().forEach(m => {
                const msgDiv = document.createElement("div");
                msgDiv.textContent = `${m.author.username}: ${m.content}`;
                chatDiv.appendChild(msgDiv);
            });
        } catch(e){console.error(e);}
    }

    fetchMessages();
    chatInterval = setInterval(fetchMessages, 5000);
}

// --- Message input placeholder ---
document.getElementById("messageInput").addEventListener("keydown", async e => {
    if(e.key==="Enter"){
        e.target.value = "";
        // sending messages requires bot/backend
    }
});

// --- Initialize ---
updateUI();
</script>
</body>
</html>
