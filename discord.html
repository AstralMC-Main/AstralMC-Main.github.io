<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstralMC Discord Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: sans-serif; margin:0; padding:0; background:#1e1e1e; color:white; }
header { padding: 10px; text-align:center; }
select, button { padding:8px; margin:5px; }
#chat { width:100%; height:70vh; background:#2e2e2e; overflow:auto; padding:5px; }
#input { width:80%; padding:8px; }
#send { padding:8px; }
</style>
</head>
<body>

<header>
<h1>AstralMC Discord Chat</h1>
<button id="loginBtn">Login with Discord</button>
<br>
<select id="guildSelect"></select>
<select id="channelSelect"></select>
<br>
<input id="input" placeholder="Message..."><button id="send">Send</button>
</header>

<div id="chat"></div>

<script>
const BACKEND = "https://started-gel.gl.at.ply.gg:38956"; // replace with your backend URL
let token = localStorage.getItem("discord_token");

// ---------------- LOGIN ----------------
document.getElementById("loginBtn").onclick = () => {
  window.location.href = `${BACKEND}/login`;
};

// Read token from hash if OAuth redirect
if (location.hash.includes("access_token")) {
  const params = new URLSearchParams(location.hash.slice(1));
  token = params.get("access_token");
  localStorage.setItem("discord_token", token);
  location.hash = "";
}

// ---------------- MUTUAL GUILDS ----------------
async function loadGuilds() {
  if (!token) return;
  const guilds = await fetch(`${BACKEND}/mutualGuilds?token=${token}`).then(r=>r.json());
  const sel = document.getElementById("guildSelect");
  sel.innerHTML = "";
  guilds.forEach(g=>{
    const opt = document.createElement("option");
    opt.value = g.id;
    opt.textContent = g.name;
    sel.appendChild(opt);
  });
  loadChannels();
}

// ---------------- CHANNELS ----------------
async function loadChannels() {
  const gid = document.getElementById("guildSelect").value;
  const sel = document.getElementById("channelSelect");
  sel.innerHTML = "";
  const chans = await fetch(`${BACKEND}/channels/${gid}`).then(r=>r.json());
  chans.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    sel.appendChild(opt);
  });
  connectWS();
}

document.getElementById("guildSelect").onchange = loadChannels;

// ---------------- SEND MESSAGE ----------------
document.getElementById("send").onclick = async () => {
  const guildId = document.getElementById("guildSelect").value;
  const channelId = document.getElementById("channelSelect").value;
  const content = document.getElementById("input").value;
  if (!content) return;
  await fetch(`${BACKEND}/sendMessage`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({guildId, channelId, content})
  });
  document.getElementById("input").value = "";
};

// ---------------- WEBSOCKET ----------------
let ws;
function connectWS() {
  if(ws) ws.close();
  ws = new WebSocket(`${BACKEND.replace(/^http/,"ws")}/ws`);
  ws.onopen = ()=>{
    const guildId = document.getElementById("guildSelect").value;
    const channelId = document.getElementById("channelSelect").value;
    ws.send(JSON.stringify({guildId, channelId}));
  };
  ws.onmessage = (msg)=>{
    const data = JSON.parse(msg.data);
    const chat = document.getElementById("chat");
    const div = document.createElement("div");
    div.textContent = `${data.author?.username || 'Bot'}: ${data.content}`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  };
}

loadGuilds();
</script>
</body>
</html>