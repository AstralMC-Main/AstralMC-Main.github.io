<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstralMC Discord Widget</title>
<style>
body {
    font-family: sans-serif;
    background: #2f3136;
    color: #fff;
    margin: 0;
    display: flex;
    height: 100vh;
}
#sidebar {
    width: 250px;
    background: #202225;
    padding: 10px;
    box-sizing: border-box;
}
#content {
    flex: 1;
    padding: 10px;
    display: flex;
    flex-direction: column;
}
button {
    margin: 5px 0;
    padding: 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}
#loginBtn { background: #5865f2; color: #fff; }
#logoutBtn { background: #f04747; color: #fff; display: none; }
#user { margin-bottom: 10px; }
#chat { flex: 1; overflow-y: auto; background: #36393f; padding: 10px; border-radius: 8px; }
#messageInput { margin-top: 10px; padding: 8px; border-radius: 8px; border: none; width: 100%; }
</style>
</head>
<body>

<div id="sidebar">
    <div id="user"></div>
    <button id="loginBtn">Login with Discord</button>
    <button id="logoutBtn">Logout</button>
    <div id="servers"></div>
</div>

<div id="content">
    <div id="chat"></div>
    <input id="messageInput" placeholder="Type a message..." />
</div>

<script>
const backendURL = "http://started-gel.gl.at.ply.gg:38956";
let token = localStorage.getItem("discord_token");

// Handle OAuth callback
(function handleOAuthCallback() {
    const hash = window.location.hash;
    if (hash.includes("access_token")) {
        const params = new URLSearchParams(hash.slice(1));
        token = params.get("access_token");
        if(token) localStorage.setItem("discord_token", token);
        history.replaceState(null, "", window.location.pathname);
    }
})();

// Update login UI
async function updateUI() {
    if(!token) return;
    try{
        const res = await fetch(`${backendURL}/me?token=${token}`);
        const user = await res.json();
        document.getElementById("user").textContent = `Logged in as ${user.username}#${user.discriminator}`;
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";
        loadGuilds();
    } catch(e){
        console.error(e);
    }
}

// Login button
document.getElementById("loginBtn").onclick = () => {
    window.location.href = `${backendURL}/login`;
};

// Logout button
document.getElementById("logoutBtn").onclick = () => {
    localStorage.removeItem("discord_token");
    token=null;
    document.getElementById("user").textContent="";
    document.getElementById("loginBtn").style.display="inline-block";
    document.getElementById("logoutBtn").style.display="none";
    document.getElementById("servers").innerHTML="";
    document.getElementById("chat").innerHTML="";
};

// Fetch user's guilds
async function loadGuilds() {
    if(!token) return;
    try {
        const res = await fetch('https://discord.com/api/users/@me/guilds', {
            headers: { Authorization: `Bearer ${token}` }
        });
        const guilds = await res.json();
        const serversDiv = document.getElementById("servers");
        serversDiv.innerHTML = "";
        guilds.forEach(g => {
            const btn = document.createElement("button");
            btn.textContent = g.name;
            btn.onclick = ()=>loadChannels(g.id);
            serversDiv.appendChild(btn);
        });
    } catch(e) { console.error(e); }
}

// Load channels for selected guild
async function loadChannels(guildId) {
    if(!token) return;
    try {
        const res = await fetch(`https://discord.com/api/guilds/${guildId}/channels`, {
            headers: { Authorization: `Bearer ${token}` }
        });
        const channels = await res.json();
        const serversDiv = document.getElementById("servers");
        serversDiv.querySelectorAll("button").forEach(b => b.style.fontWeight = b.textContent === guildId ? "bold" : "normal");
        const channelDiv = document.createElement("div");
        channelDiv.id = "channels";
        channelDiv.innerHTML="";
        channels.forEach(c=>{
            if(c.type===0){ // text channel
                const chBtn = document.createElement("button");
                chBtn.textContent=c.name;
                chBtn.onclick=()=>loadMessages(guildId, c.id);
                channelDiv.appendChild(chBtn);
            }
        });
        serversDiv.appendChild(channelDiv);
    } catch(e){console.error(e);}
}

// Load messages
async function loadMessages(guildId, channelId){
    if(!token) return;
    try{
        const res = await fetch(`https://discord.com/api/channels/${channelId}/messages?limit=20`, {
            headers:{ Authorization:`Bearer ${token}` }
        });
        const messages = await res.json();
        const chatDiv = document.getElementById("chat");
        chatDiv.innerHTML="";
        messages.reverse().forEach(m=>{
            const msgDiv = document.createElement("div");
            msgDiv.textContent = `${m.author.username}: ${m.content}`;
            chatDiv.appendChild(msgDiv);
        });
    } catch(e){console.error(e);}
}

// Message sending
document.getElementById("messageInput").addEventListener("keydown", async e=>{
    if(e.key==="Enter" && token){
        const input = e.target;
        const content = input.value;
        if(!content) return;
        try{
            // Send message via backend if implemented, or using Discord Bot token
            input.value="";
        } catch(err){console.error(err);}
    }
});

updateUI();
</script>
</body>
</html>
