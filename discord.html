<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Chat Widget (Discord OAuth2)</title>
  <style>
    /* BASIC STYLES */
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background: transparent;
      overflow: hidden;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    /* CHAT BUTTON */
    #chatWidgetButton {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #5865F2;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      overflow: hidden;
      padding: 0;
      transition: all 0.3s ease;
    }

    #discordIconImg {
      width: 53%;
      height: 40%;
      margin: auto;
      transition: all 0.3s ease;
    }

    /* CHAT POPUP */
    #chatPopup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #5865F2;
      border-radius: 50%;
      z-index: 999;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      transition: all 0.5s ease;
    }

    #chatPopup.open {
      width: 90vw;
      height: 90vh;
      background: #36393f;
      border-radius: 10px;
    }

    /* CHAT CONTENT */
    #chatContent {
      display: none;
      height: 100%;
      width: 100%;
      opacity: 0;
      transition: opacity 0.5s ease;
      flex-direction: row;
    }

    #chatContent.show {
      display: flex;
      opacity: 1;
    }

    #sidebar {
      width: 200px;
      background: #2f3136;
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-right: 1px solid #40444b;
      overflow-y: auto;
      max-height: 100%;
    }

    .channel {
      color: #b9bbbe;
      font-size: 14px;
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .channel:hover {
      background: #40444b;
    }

    .channel.active {
      background: #5865f2;
      color: white;
    }

    #mainArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      background: #2f3136;
      padding: 10px;
    }

    .message {
      display: flex;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 8px;
      flex-shrink: 0;
    }

    .messageContent {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      word-break: break-word;
      max-width: calc(100% - 40px);
    }

    .header {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 4px;
    }

    .username {
      font-weight: bold;
      font-size: 12px;
      color: #fff;
      margin-bottom: 2px;
    }

    .timestamp {
      color: #72767d;
      font-size: 10px;
    }

    .text {
      color: #dcddde;
      font-size: 12px;
      word-break: break-word;
      text-align: left;
    }

    #inputArea {
      background: #40444b;
      padding: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #messageInput {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 6px;
      background-color: #2f3136;
      color: #dcddde;
      font-size: 12px;
    }

    #sendButton {
      background-color: #5865f2;
      border: none;
      border-radius: 7px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      padding: 8px 10px;
      width: 40px;
      height: 40px;
      transition: background-color 0.3s;
    }

    #sendButton:hover {
      background-color: #4752c4;
    }

    #loginButton, #logoutButton {
      background-color: #5865f2;
      border: none;
      border-radius: 5px;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      padding: 8px 10px;
      width: 100%;
      margin-top: 5px;
      transition: background-color 0.3s;
    }

    #loginButton:hover, #logoutButton:hover {
      background-color: #4752c4;
    }

    .serverload {
      color: #5865f2;
    }
  </style>
</head>
<body>

<!-- CHAT BUTTON (outside popup) -->
<button id="chatWidgetButton">
  <img id="discordIconImg" src="https://raw.githubusercontent.com/AstralMC-Main/AstralMC-Main.github.io/refs/heads/main/Discord_Symbol_White.png" alt="Discord Logo">
</button>

<!-- CHAT POPUP -->
<div id="chatPopup">
  <div id="chatContent">
    <div id="sidebar"></div>
    <div id="mainArea">
      <div id="chat"></div>
      <div id="inputArea">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button id="sendButton">âž¤</button>
      </div>
      <button id="loginButton" href="https://discord.com/oauth2/authorize?client_id=1366498578822070323&redirect_uri=http%3A%2F%2F28.ip.gl.ply.gg%3A4367%2Fcallback&response_type=token&scope=identify%20guilds">Login with Discord</button>
      <button id="logoutButton" style="display:none;">Logout</button>
    </div>
  </div>
</div>

<script>
  const backendUrl = 'http://28.ip.gl.ply.gg:4367';
  const clientId = '1366498578822070323';
  const redirectUri = encodeURIComponent('http://28.ip.gl.ply.gg:4367/callback');
  const scope = encodeURIComponent('identify guilds');
  const responseType = 'code';

  const chatPopup = document.getElementById('chatPopup');
  const chatContent = document.getElementById('chatContent');
  const messageInput = document.getElementById('messageInput');
  const chat = document.getElementById('chat');
  const loginButton = document.getElementById('loginButton');
  const logoutButton = document.getElementById('logoutButton');
  const chatWidgetButton = document.getElementById('chatWidgetButton');
  const sendButton = document.getElementById('sendButton');

  let currentGuild = null;
  let currentChannel = null;

  chatWidgetButton.addEventListener('click', () => {
    if (!chatPopup.classList.contains('open')) {
      chatPopup.classList.add('open');
      chatWidgetButton.style.display = 'none';
      setTimeout(() => {
        chatContent.classList.add('show');
        loadServers();
      }, 300);
    }
  });

  loginButton.addEventListener('click', () => {
    const discordOauthUrl = `https://discord.com/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=${responseType}&scope=${scope}`;
    window.location.href = discordOauthUrl;
  });

  logoutButton.addEventListener('click', () => {
    localStorage.removeItem('discord_token');
    logoutButton.style.display = 'none';
    loginButton.style.display = 'block';
  });

  sendButton.addEventListener('click', async () => {
    const message = messageInput.value.trim();
    if (!message || !currentChannel) return;
    
  messageInput.addEventListener('keydown', (event) => {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault(); // prevent newline
      sendButton.click(); // simulate send button click
    }
  });

    sendButton.disabled = true;
    try {
      const response = await fetch(`${backendUrl}/send`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          channelId: currentChannel,
          message
        })
      });

      const result = await response.json();
      if (result.success) {
        messageInput.value = '';
        loadMessages(currentGuild, currentChannel);
      } else {
        console.error('Failed to send message:', result.error);
      }
    } catch (err) {
      console.error('Send error:', err);
    }
    sendButton.disabled = false;
  });

  function handleRedirect() {
    const hash = window.location.hash;
    if (hash.includes('access_token')) {
      const params = new URLSearchParams(hash.slice(1));
      const token = params.get('access_token');
      if (token) {
        localStorage.setItem('discord_token', token);
        loginButton.style.display = 'none';
        logoutButton.style.display = 'block';
      }
    }
  }
  handleRedirect();
  
  messageInput.addEventListener('keydown', function (event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendButton.click();
    }
  });

  async function loadServers() {
    const sidebar = document.getElementById('sidebar');
    sidebar.innerHTML = '<div class="serverload">Loading servers...</div>';
    try {
      const response = await fetch(`${backendUrl}/guilds`);
      const servers = await response.json();
      sidebar.innerHTML = '';

      servers.forEach(server => {
        const serverElement = document.createElement('div');
        serverElement.classList.add('channel');
        serverElement.innerText = server.name;
        serverElement.addEventListener('click', () => {
          loadChannels(server.id);
          currentGuild = server.id;
        });
        sidebar.appendChild(serverElement);
      });
    } catch (err) {
      console.error('Failed to load servers', err);
    }
  }

  async function loadChannels(guildId) {
    const sidebar = document.getElementById('sidebar');
    sidebar.innerHTML = '<div class="serverload">Loading channels...</div>';
    try {
      const response = await fetch(`${backendUrl}/channels/${guildId}`);
      const channels = await response.json();
      sidebar.innerHTML = '';

      channels.forEach(channel => {
        const channelElement = document.createElement('div');
        channelElement.classList.add('channel');
        channelElement.innerText = `# ${channel.name}`;
        channelElement.addEventListener('click', () => {
          currentChannel = channel.id;
          loadMessages(currentGuild, currentChannel);
          startPolling(); // begin polling new messages
        });
        sidebar.appendChild(channelElement);
      });
    } catch (err) {
      console.error('Failed to load channels', err);
    }
  }
  let lastMessageId = null;
  let pollInterval = null;
  
  async function loadMessages(guildId, channelId, initialLoad = true) {
    try {
      const response = await fetch(`${backendUrl}/messages/${channelId}${lastMessageId ? `?after=${lastMessageId}` : ''}`);
      const messages = await response.json();

      const newMessages = lastMessageId
        ? messages.filter(msg => msg.id > lastMessageId)
        : messages;
      
    if (newMessages.length > 0) {
      const isAtBottom = chat.scrollTop + chat.clientHeight === chat.scrollHeight;

      newMessages.forEach(addMessageToChat);
      chat.scrollTop = chat.scrollHeight;
      lastMessageId = newMessages[newMessages.length - 1].id;
      if (isAtBottom) {
        chat.scrollTop = chat.scrollHeight;
      }
    }
  } catch (err) {
    console.error('Failed to load messages', err);
  }
}
  function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(() => {
      loadMessages(currentGuild, currentChannel, false);
    }, 100); // every 0.1 seconds
  }

  function stopPolling() {
    if (pollInterval) clearInterval(pollInterval);
  }
let lastAuthorId = null;
let lastMessageTime = 0;

let lastMessage = null;

function addMessageToChat(message) {
  let currentTime;
  try {
    currentTime = new Date(message.timestamp);
    if (isNaN(currentTime)) throw new Error('Invalid Date');
  } catch (e) {
    console.warn('Invalid timestamp:', message.timestamp);
    currentTime = new Date();
  }

  const lastTime = lastMessage ? new Date(lastMessage.timestamp) : null;
  const shouldGroup =
    lastMessage &&
    message.author.username === lastMessage.author.username &&
    lastTime &&
    (currentTime - lastTime < 7 * 60 * 1000);

  if (shouldGroup) {
    const lastMsgElem = chat.lastElementChild;
    const lastText = document.createElement('div');
    lastText.classList.add('text');
    lastText.innerText = message.content;
    lastMsgElem.querySelector('.messageContent').appendChild(lastText);
  } else {
    const messageElement = document.createElement('div');
    messageElement.classList.add('message');

    const avatar = document.createElement('img');
    avatar.classList.add('avatar');
  
    if (message.author?.avatar) {
      avatar.src = `https://cdn.discordapp.com/avatars/${message.author.id}/${message.author.avatar}.png`;
    } else {
      avatar.src = 'https://cdn.discordapp.com/embed/avatars/0.png'; // fallback avatar
    }
    messageElement.appendChild(avatar);

    const content = document.createElement('div');
    content.classList.add('messageContent');

    const header = document.createElement('div');
    header.classList.add('header');

    const username = document.createElement('span');
    username.classList.add('username');
    username.innerText = message.author.username;

    const timestamp = document.createElement('span');
    timestamp.classList.add('timestamp');
    timestamp.innerText = currentTime.toLocaleTimeString([], {
      hour: '2-digit',
      minute: '2-digit'
    });

    header.appendChild(username);
    header.appendChild(timestamp);

    const text = document.createElement('div');
    text.classList.add('text');
    text.innerText = message.content;

    content.appendChild(header);
    content.appendChild(text);
    messageElement.appendChild(content);
    chat.appendChild(messageElement);
  }

  lastMessage = message;
}
</script>
</body>
</html>
