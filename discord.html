<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Discord Widget</title>
  <style>
    body { font-family: sans-serif; display: flex; margin: 0; height: 100vh; }
    #sidebar { background: #2c2f33; color: white; padding: 10px; width: 200px; overflow-y: auto; }
    #channels { background: #23272a; color: white; padding: 10px; width: 200px; overflow-y: auto; }
    #chat { flex: 1; display: flex; flex-direction: column; background: #36393f; }
    #messages { flex: 1; overflow-y: auto; padding: 10px; color: white; }
    #messageInput { display: flex; }
    #messageInput input { flex: 1; padding: 5px; }
    #messageInput button { padding: 5px; }
    button { cursor: pointer; margin-top: 5px; }
  </style>
</head>
<body>

<div id="sidebar">
  <div id="userInfo"></div>
  <button id="loginBtn">Login with Discord</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
  <h3>Servers</h3>
  <div id="guildList"></div>
</div>

<div id="channels">
  <h3>Channels</h3>
  <div id="channelList"></div>
</div>

<div id="chat">
  <div id="messages"></div>
  <div id="messageInput">
    <input type="text" id="msgText" placeholder="Type a message..." />
    <button id="sendMsg">Send</button>
  </div>
</div>

<script>
const backendURL = "http://localhost:3000"; // Change to your backend URL
let selectedGuild = null;
let selectedChannel = null;
let ws = null;

async function checkLogin() {
  let res = await fetch(`${backendURL}/me`, { credentials: 'include' });
  if (res.ok) {
    let user = await res.json();
    document.getElementById('userInfo').innerHTML = `
      <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" width="40" style="border-radius:50%;" />
      <span>${user.username}</span>
    `;
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'block';
    loadGuilds();
    connectWS();
  } else {
    document.getElementById('loginBtn').style.display = 'block';
    document.getElementById('logoutBtn').style.display = 'none';
  }
}

async function loadGuilds() {
  let res = await fetch(`${backendURL}/guilds`, { credentials: 'include' });
  let guilds = await res.json();
  let list = document.getElementById('guildList');
  list.innerHTML = '';
  guilds.forEach(g => {
    let btn = document.createElement('button');
    btn.textContent = g.name;
    btn.onclick = () => {
      selectedGuild = g.id;
      loadChannels(g.id);
    };
    list.appendChild(btn);
  });
}

async function loadChannels(guildId) {
  let res = await fetch(`${backendURL}/channels/${guildId}`, { credentials: 'include' });
  let chans = await res.json();
  let list = document.getElementById('channelList');
  list.innerHTML = '';
  chans.forEach(c => {
    let btn = document.createElement('button');
    btn.textContent = `#${c.name}`;
    btn.onclick = () => {
      selectedChannel = c.id;
      loadMessages(c.id);
    };
    list.appendChild(btn);
  });
}

async function loadMessages(channelId) {
  let res = await fetch(`${backendURL}/messages/${channelId}`, { credentials: 'include' });
  let msgs = await res.json();
  let msgDiv = document.getElementById('messages');
  msgDiv.innerHTML = '';
  msgs.forEach(m => addMessage(m));
}

function addMessage(m) {
  let msgDiv = document.getElementById('messages');
  let el = document.createElement('div');
  el.textContent = `${m.author.username}: ${m.content}`;
  msgDiv.appendChild(el);
  msgDiv.scrollTop = msgDiv.scrollHeight;
}

function connectWS() {
  ws = new WebSocket(`${backendURL.replace('http', 'ws')}/ws`);
  ws.onmessage = (event) => {
    let data = JSON.parse(event.data);
    if (data.channelId === selectedChannel) {
      addMessage(data);
    }
  };
}

document.getElementById('loginBtn').onclick = () => {
  window.location.href = `${backendURL}/auth/discord`;
};

document.getElementById('logoutBtn').onclick = async () => {
  await fetch(`${backendURL}/logout`, { method: 'POST', credentials: 'include' });
  location.reload();
};

document.getElementById('sendMsg').onclick = async () => {
  if (!selectedChannel) return;
  let content = document.getElementById('msgText').value;
  if (!content) return;
  await fetch(`${backendURL}/messages/${selectedChannel}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ content })
  });
  document.getElementById('msgText').value = '';
};

checkLogin();
</script>

</body>
</html>