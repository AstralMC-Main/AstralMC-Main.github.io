<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AstralMC Discord Widget</title>
<style>
body { font-family: sans-serif; display: flex; margin: 0; height: 100vh; }
#sidebar { background: #2c2f33; color: white; padding: 10px; width: 200px; overflow-y: auto; }
#channels { background: #23272a; color: white; padding: 10px; width: 200px; overflow-y: auto; }
#chat { flex: 1; display: flex; flex-direction: column; background: #36393f; }
#messages { flex: 1; overflow-y: auto; padding: 10px; color: white; }
#messageInput { display: flex; }
#messageInput input { flex: 1; padding: 5px; }
#messageInput button { padding: 5px; }
button { cursor: pointer; margin-top: 5px; }
</style>
</head>
<body>

<div id="sidebar">
  <div id="userInfo"></div>
  <button id="loginBtn">Login with Discord</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
  <h3>Servers</h3>
  <div id="guildList"></div>
</div>

<div id="channels">
  <h3>Channels</h3>
  <div id="channelList"></div>
</div>

<div id="chat">
  <div id="messages"></div>
  <div id="messageInput">
    <input type="text" id="msgText" placeholder="Type a message..." />
    <button id="sendMsg">Send</button>
  </div>
</div>

<script>
const backendURL = "http://started-gel.gl.at.ply.gg:38956"; // Your Playit backend
let token = localStorage.getItem("discord_token");
let selectedGuild = null;
let selectedChannel = null;
let ws = null;

/* --- Read token from URL fragment if present --- */
function handleOAuthCallback() {
  const hash = window.location.hash;
  if (hash.includes("access_token")) {
    const params = new URLSearchParams(hash.slice(1));
    token = params.get("access_token");
    if (token) {
      localStorage.setItem("discord_token", token);
    }
    // Clean URL
    history.replaceState(null, "", window.location.pathname);
  }
}
handleOAuthCallback();

/* --- UI Elements --- */
const userInfo = document.getElementById('userInfo');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const guildList = document.getElementById('guildList');
const channelList = document.getElementById('channelList');
const messagesDiv = document.getElementById('messages');
const msgText = document.getElementById('msgText');
const sendMsg = document.getElementById('sendMsg');

function setLoggedOutUI() {
  userInfo.textContent = '';
  loginBtn.style.display = 'block';
  logoutBtn.style.display = 'none';
  guildList.innerHTML = '';
  channelList.innerHTML = '';
  messagesDiv.innerHTML = '';
}

function setLoggedInUI(user) {
  userInfo.innerHTML = `<img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" width="40" style="border-radius:50%;" /> <span>${user.username}#${user.discriminator}</span>`;
  loginBtn.style.display = 'none';
  logoutBtn.style.display = 'block';
}

/* --- Backend API helpers --- */
async function apiRequest(path, method = 'GET', body=null) {
  const opts = { method, headers:{}, credentials:'include' };
  if (token) opts.headers['Authorization'] = `Bearer ${token}`;
  if (body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
  const res = await fetch(`${backendURL}${path}`, opts);
  if(!res.ok) throw new Error(res.statusText);
  return res.json();
}

async function fetchUser() {
  try {
    const user = await apiRequest('/me');
    setLoggedInUI(user);
    return user;
  } catch(e) {
    setLoggedOutUI();
    token = null;
    localStorage.removeItem("discord_token");
    console.error("User fetch failed", e);
  }
}

/* --- Load guilds and channels --- */
async function loadGuilds() {
  const guilds = await apiRequest('/mutualGuilds');
  guildList.innerHTML = '';
  guilds.forEach(g => {
    const btn = document.createElement('button');
    btn.textContent = g.name;
    btn.onclick = () => { selectedGuild = g.id; loadChannels(g.id); };
    guildList.appendChild(btn);
  });
}

async function loadChannels(guildId) {
  const chans = await apiRequest(`/channels/${guildId}`);
  channelList.innerHTML = '';
  chans.forEach(c => {
    if(c.type !== 0) return;
    const btn = document.createElement('button');
    btn.textContent = `#${c.name}`;
    btn.onclick = () => { selectedChannel = c.id; loadMessages(c.id); };
    channelList.appendChild(btn);
  });
}

async function loadMessages(channelId) {
  const msgs = await apiRequest(`/messages/${channelId}?limit=50`);
  messagesDiv.innerHTML = '';
  msgs.forEach(addMessage);
}

function addMessage(m) {
  const el = document.createElement('div');
  el.textContent = `${m.author.username}: ${m.content}`;
  messagesDiv.appendChild(el);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* --- WebSocket for live messages --- */
function connectWS() {
  ws = new WebSocket(backendURL.replace('http','ws')+'/ws');
  ws.onmessage = (ev)=> {
    const data = JSON.parse(ev.data);
    if (data.channelId === selectedChannel) addMessage(data);
  };
}

/* --- Button handlers --- */
loginBtn.onclick = () => window.location.href = `${backendURL}/login`;
logoutBtn.onclick = async () => {
  await fetch(`${backendURL}/logout`, { method:'POST', credentials:'include' });
  localStorage.removeItem("discord_token");
  token = null;
  setLoggedOutUI();
};
sendMsg.onclick = async () => {
  if(!selectedChannel) return;
  const content = msgText.value.trim();
  if(!content) return;
  await apiRequest(`/sendMessage`, 'POST', { guildId:selectedGuild, channelId:selectedChannel, content });
  msgText.value = '';
};

/* --- Boot --- */
(async function boot() {
  if(token) {
    await fetchUser();
    await loadGuilds();
    connectWS();
  } else {
    setLoggedOutUI();
  }
})();
</script>

</body>
</html>