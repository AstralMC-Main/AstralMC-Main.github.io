<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AstralMC Discord Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family:sans-serif; margin:0; padding:0; background:#1e1e1e; color:white;}
header { padding:10px; text-align:center;}
select, button, input { padding:8px; margin:5px;}
#chat { width:100%; height:70vh; background:#2e2e2e; overflow:auto; padding:5px; border-radius:6px;}
#input { width:70%; border-radius:4px;}
#send { border-radius:4px;}
</style>
</head>
<body>
<header>
<h1>AstralMC Discord Chat</h1>
<button id="loginBtn">Login with Discord</button>
<br>
<select id="guildSelect"></select>
<select id="channelSelect"></select>
<br>
<input id="input" placeholder="Message...">
<button id="send">Send</button>
</header>
<div id="chat"></div>

<script>
const BACKEND = "http://started-gel.gl.at.ply.gg:38956"; // Playit.gg public URL

// -------------------- Handle OAuth2 callback --------------------
function handleOAuthCallback() {
    if (location.hash.includes("access_token")) {
        const hash = new URLSearchParams(location.hash.slice(1));
        const accessToken = hash.get("access_token");
        if (accessToken) {
            localStorage.setItem("discord_token", accessToken);
            console.log("Discord token saved:", accessToken);
            history.replaceState(null, "", location.pathname + location.search);
        }
    }
}
handleOAuthCallback();

// Get token from storage
let token = localStorage.getItem("discord_token");

// -------------------- Login button --------------------
document.getElementById("loginBtn").onclick = ()=>{
    window.location.href = `${BACKEND}/login`;
};

// -------------------- Load mutual guilds --------------------
async function loadGuilds(){
    if(!token) return;
    try{
        const guilds = await fetch(`${BACKEND}/mutualGuilds?token=${token}`).then(r=>r.json());
        const sel = document.getElementById("guildSelect");
        sel.innerHTML="";
        guilds.forEach(g=>{
            const opt = document.createElement("option");
            opt.value=g.id;
            opt.textContent=g.name;
            sel.appendChild(opt);
        });
        loadChannels();
    }catch(e){console.error(e);}
}

// -------------------- Load channels --------------------
async function loadChannels(){
    const gid = document.getElementById("guildSelect").value;
    if(!gid) return;
    try{
        const chans = await fetch(`${BACKEND}/channels/${gid}`).then(r=>r.json());
        const sel = document.getElementById("channelSelect");
        sel.innerHTML="";
        chans.forEach(c=>{
            const opt = document.createElement("option");
            opt.value=c.id;
            opt.textContent=c.name;
            sel.appendChild(opt);
        });
        connectWS();
    }catch(e){console.error(e);}
}

document.getElementById("guildSelect").onchange = loadChannels;

// -------------------- Send message --------------------
document.getElementById("send").onclick = async ()=>{
    const guildId = document.getElementById("guildSelect").value;
    const channelId = document.getElementById("channelSelect").value;
    const content = document.getElementById("input").value;
    if(!content) return;
    try{
        await fetch(`${BACKEND}/sendMessage`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({guildId, channelId, content})
        });
        document.getElementById("input").value="";
    }catch(e){console.error(e);}
};

// -------------------- WebSocket connection --------------------
let ws;
function connectWS(){
    if(ws) ws.close();
    ws = new WebSocket(`${BACKEND.replace(/^http/,"ws")}/ws`);
    ws.onopen = ()=>{
        const guildId = document.getElementById("guildSelect").value;
        const channelId = document.getElementById("channelSelect").value;
        ws.send(JSON.stringify({guildId,channelId}));
    };
    ws.onmessage = (msg)=>{
        try{
            const data = JSON.parse(msg.data);
            const chat = document.getElementById("chat");
            const div = document.createElement("div");
            div.textContent = `${data.author?.username || 'Bot'}: ${data.content}`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }catch(e){console.error(e);}
    };
}

// -------------------- Initialize --------------------
if(token){
    loadGuilds();
}
</script>
</body>
</html>