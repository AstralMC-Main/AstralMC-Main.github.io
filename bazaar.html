<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hypixel Skyblock Bazaar Viewer</title>
<style>
:root{
  --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#60a5fa;
  --glass: rgba(255,255,255,0.03); --text: #ffffff;
}

html,body{ height:100%; margin:0; font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; overflow-x:hidden; }
body{ background: linear-gradient(180deg,#071025 0%, #071827 100%); color:#e6eef8; padding:12px; box-sizing:border-box; }

header{ display:flex; flex-direction:column; gap:8px; align-items:flex-start; margin-bottom:12px; width:100%; padding:0 8px; box-sizing:border-box; }
h1{ margin:0; font-size:20px; word-break: break-word; }

.controls{ display:flex; flex-wrap:wrap; gap:8px; width:100%; overflow:hidden; padding:0 4px; box-sizing:border-box; }
button{ cursor:pointer; }
button.small{ font-size:12px; padding:4px 6px; height:auto; }

#list{ display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:10px; margin-top:12px; padding:0 4px; box-sizing:border-box; }
#list:hover{ cursor:pointer; }

.card{ background:var(--glass); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); box-shadow:0 6px 18px rgba(2,6,23,0.6); transition: transform 0.2s ease;}

.row{ display:flex; justify-content:space-between; align-items:center; gap:6px; }
.id{ font-weight:700; font-size:13px; word-break:break-word; color:var(--text)}
.price{ font-family:monospace; }
.muted-small{ color:var(--muted); font-size:12px; }
.muted{ color:var(--muted); font-size:12px; }

.json{ margin-top:6px; background:#07111a; padding:6px; border-radius:6px; white-space:pre-wrap; font-family:monospace; font-size:12px; display:none; max-height:200px; overflow:auto; }

.controls-bar{ display:flex; flex-wrap: wrap; gap: 6px; align-items:center; padding:0 4px; box-sizing:border-box; }
.controls-bar input, .controls-bar select, .controls-bar button { flex-shrink: 1; min-width: 0; max-width: 100%; }
#q { flex: 1 1 40px; min-width: 100px; height:auto; }

.footer{ margin-top:10px; color:var(--muted); font-size:13px; padding:0 4px; box-sizing:border-box; }
.grid-left{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; min-width:0; }
.page{ display:inline-flex; gap:4px; align-items:center; }
.pill{ background:rgba(255,255,255,0.03); padding:4px 8px; border-radius:999px; font-size:12px; margin-left:4px; }

#settingsBtn{}
.settings-modal{
  position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7);
  display:none; align-items:center; justify-content:center; z-index:1000;
}
.settings-content{
  background:var(--card); padding:20px; border-radius:12px; width:300px; max-width:90%;
  display:flex; flex-direction:column; gap:12px;
}
.settings-content h2{ margin:0 0 10px 0; font-size:18px; }
.settings-row{ display:flex; justify-content:space-between; align-items:center; }
.settings-row label{ font-size:14px; }
.settings-close{ background:var(--accent); border: 1px solid transparent; color:#fff; padding:6px 12px; border-radius:8px; cursor:pointer; align-self:flex-end; }

@media (max-width: 768px) {
  body { padding:8px; }
  header, .controls, .controls-bar, #list, .footer { padding:0 4px; }
  .controls { flex-direction: column; gap:6px; }
  .controls-bar { flex-direction: column; align-items: stretch; gap:4px; width:100%; }
  input, select, button { width:100%; max-width:100%; }
  #list { grid-template-columns:1fr; }
}
@media (max-width: 480px) {
  h1 { font-size:18px; }
  .pill { font-size:11px; padding:3px 6px; }
  .small { font-size:11px; padding:4px 5px; }
  .controls input, .controls select, .controls button { font-size:11px; padding:4px 5px; height:auto; }
}
.order-row {
  display: grid;
  grid-template-columns: 1fr 1fr; /* two equal columns */
  gap: 8px;
  padding: 2px 0;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.order-row div:first-child {
  border-right: 1px solid rgba(255,255,255,0.2);
  padding-right: 8px;
  text-align: right;
}

.order-row div:last-child {
  text-align: right;
}
/* Toggle switch style */
.switch {
  position: relative;
  display: inline-block;
  width: 42px;
  height: 22px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(255,255,255,0.2);
  transition: 0.3s;
  border-radius: 22px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 2px;
  bottom: 2px;
  background-color: #fff;
  transition: 0.3s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: var(--accent);
}

input:checked + .slider:before {
  transform: translateX(20px);
}
input,select,button{ background:var(--card); border:1px solid rgba(255,255,255,0.04); color:inherit; border-radius:8px; font-size:14px; min-width:0; flex-shrink:1; box-sizing:border-box; padding:4px 8px; line-height:1.2; height:auto; outline:none; transition:0.2s;}
select{cursor:pointer;}
input:hover,select:hover,button:hover{
    background:var(--card);
    border:1px solid var(--accent);
}
input:focus,select:focus,button:focus{
    background:var(--card);
    border:1px solid var(--accent);
}
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0; /* Removes extra margin that might appear */
}

/* For Firefox */
input[type="number"] {
  -moz-appearance: textfield;
}
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
}



.card:hover {
  transform: scale(1.03);
}

.card.expanded {
  position: fixed;
  top: 50%;
  left: 50%;
  width: 80%;
  max-width: 700px;
  height: auto;
  transform: translate(-50%, -50%);
  z-index: 1001;
  box-shadow: 0 0 25px rgba(0,0,0,0.7);
}

.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 1000;
  display: none;
}

.overlay.active {
  display: block;
}
</style>
</head>
<body>
<header>
  <div>
    <h1>Hypixel Skyblock Bazaar — Viewer</h1>
    <div class="muted">Fetches <code>https://api.hypixel.net/v2/skyblock/bazaar</code>. Enter API key if required.</div>
  </div>

  <div class="controls" style="margin-left:auto">
    <div class="grid-left">
      <label class="muted-small">API Key</label>
      <input id="apiKey" placeholder="(optional) Hypixel API key" style="min-width:260px" class="hover"/>
    </div>

    <div class="controls-bar">
      <input id="q" placeholder="Search product id or name" />
      <select id="sort">
        <option value="id">Sort: Product ID</option>
        <option value="buy">Sort: Buy Price</option>
        <option value="sell">Sort: Sell Price</option>
        <option value="volume">Sort: Volume</option>
        <option value="npc">Sort: NPC Price</option>
      </select>
      <button id="toggleSortOrder" class="small" style="min-width: 100px">Descending ↓</button>
      <button id="refresh" class="small">Refresh</button>
      <button id="settingsBtn" class="small">Settings</button>
    </div>
  </div>
</header>

<div class="pill muted-small">Showing <span id="count">0</span> products • Cached: <span id="cached">no</span></div>

<main id="list" aria-live="polite"></main>

<div class="footer">
  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:14px">
    <div class="muted-small">If the fetch fails with a CORS/origin error, run this from a server or use a simple proxy (CORS). This page caches the last successful response in localStorage.</div>
    <div style="margin-left:auto" class="muted-small">Last updated: <span id="lastUpdated">—</span></div>
  </div>
</div>

<!-- Settings Modal -->
<!-- Settings Modal -->
<div id="settingsModal" class="settings-modal">
  <div class="settings-content">
    <h2>Settings</h2>

    <div class="settings-row">
      <label for="modalAutoRefresh">Auto Refresh</label>
      <label class="switch">
        <input type="checkbox" id="modalAutoRefresh">
        <span class="slider"></span>
      </label>
    </div>

    <div class="settings-row">
      <label for="modalInterval">Interval (sec)</label>
      <input type="number" id="modalInterval" value="30" style="width:60px">
    </div>

    <div class="settings-row">
      <label for="simplifyNumbers">Extend Numbers</label>
      <label class="switch">
        <input type="checkbox" id="simplifyNumbers">
        <span class="slider"></span>
      </label>
    </div>

    <h3 style="margin-top: 15px;">Theme Colors</h3>

    <div class="settings-row">
      <label for="bgPicker">Background</label>
      <input type="text" id="bgPicker" placeholder="e.g. #0f1724, rgb(15,23,36)">
    </div>

    <div class="settings-row">
      <label for="cardPicker">Card</label>
      <input type="text" id="cardPicker" placeholder="e.g. #0b1220, rgba(11,18,32,0.8)">
    </div>
    
    <div class="settings-row">
      <label for="accentPicker">Text</label>
      <input type="text" id="textPicker" placeholder="e.g. #60a5fa, rgb(96,165,250)">
    </div>
    
    <div class="settings-row">
      <label for="mutedPicker">Text 2</label>
      <input type="text" id="mutedPicker" placeholder="e.g. #94a3b8, lightgray">
    </div>

    <div class="settings-row">
      <label for="accentPicker">Accent</label>
      <input type="text" id="accentPicker" placeholder="e.g. #60a5fa, rgb(96,165,250)">
    </div>

    
    <div class="settings-row">
    </div>
      <button id="applyColors">Apply Colors</button>
      <button id="resetColors">Reset Theme</button>
      <button id="closeSettings" class="settings-close">Close</button>
  </div>
</div>

<script>
const API_BASE = 'https://api.hypixel.net/v2/skyblock/bazaar';
const ITEMS_API = 'https://api.hypixel.net/resources/skyblock/items';
const LS_KEY = 'hypixel_bazaar_cache_v2';
const LS_ITEMS_KEY = 'hypixel_items_cache_v1';
const DEFAULT_PAGE_SIZE = 200;

const apiKeyInput = document.getElementById('apiKey');
const qInput = document.getElementById('q');
const refreshBtn = document.getElementById('refresh');
const listEl = document.getElementById('list');
const countEl = document.getElementById('count');
const cachedEl = document.getElementById('cached');
const lastUpdatedEl = document.getElementById('lastUpdated');
const sortSelect = document.getElementById('sort');

let autoTimer = null;
let lastResponse = null;
let itemsMap = {};
let npcData = {};
let ascending = true;

// Fetch NPC sell prices
async function fetchNpcPrices() {
  const cached = loadItemsCache(); // reuse your existing function
  if (cached) {
    for (const [id, name] of Object.entries(cached)) {
      npcData[id] = null; // initialize with null
    }
  }

  try {
    const res = await fetch(ITEMS_API, { cache: 'no-store' });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const json = await res.json();
    if (json.items) {
      for (const item of json.items) {
        if (item.id && item.npc_sell_price !== undefined) {
          npcData[item.id] = item.npc_sell_price;
        }
      }
    }
  } catch (e) {
    console.warn('Failed to fetch NPC sell prices:', e);
  }
}
const toggleSortBtn = document.getElementById('toggleSortOrder');

toggleSortBtn.addEventListener('click', () => {
  ascending = !ascending; // flip the order
  toggleSortBtn.textContent = ascending ? 'Descending ↓' : 'Ascending ↑'; // update arrow

  if (lastResponse) renderProducts(lastResponse); // re-render list
});

// --- Settings modal elements ---
const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const modalClose = document.getElementById('closeSettings');
const modalAutoRefresh = document.getElementById('modalAutoRefresh');
const modalInterval = document.getElementById('modalInterval');
const simplifyNumbersCb = document.getElementById('simplifyNumbers');

// Load saved API key and settings
try { apiKeyInput.value = localStorage.getItem('hyp_key') || ''; } catch(e){}
try { modalAutoRefresh.checked = localStorage.getItem('autoRefresh')==='true'; } catch(e){}
try { modalInterval.value = parseInt(localStorage.getItem('autoRefreshInterval')) || 30; } catch(e){}
try { simplifyNumbersCb.checked = localStorage.getItem('simplifyNumbers')==='true'; } catch(e){}

// --- Helpers ---
function buildUrl(){ const key = (apiKeyInput.value||'').trim(); return key ? API_BASE + '?key=' + encodeURIComponent(key) : API_BASE; }

function fmtNumber(n){
  if(n===null||n===undefined) return '—';
  if(simplifyNumbersCb.checked){
    return n.toLocaleString(); // full number
  } else {
    if(Math.abs(n)>=1e6) return (n/1e6).toFixed(2)+'M';
    if(Math.abs(n)>=1e3) return (n/1e3).toFixed(1)+'k';
    if(Number.isInteger(n)) return n.toString();
    return Number(n).toFixed(2);
  }
}

function getBuyPrice(product){ return (product.quick_status && product.quick_status.buyPrice) || (product.price && product.price.buy) || (product.buy_summary && product.buy_summary.length && product.buy_summary[0].price) || null; }
function getSellPrice(product){ return (product.quick_status && product.quick_status.sellPrice) || (product.price && product.price.sell) || (product.sell_summary && product.sell_summary.length && product.sell_summary[0].price) || null; }
function getVolume(product){ return (product.quick_status && (product.quick_status.buyVolume || product.quick_status.sellVolume)) || product.volume || null; }
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function flashButtonMessage(btn,text){ const old=btn.textContent; btn.textContent=text; setTimeout(()=>btn.textContent=old,900); }

// --- Items Fetch ---
async function fetchItems(){
  const cached = loadItemsCache();
  if(cached){ itemsMap=cached; return; }
  try {
    const res = await fetch(ITEMS_API,{cache:'no-store'});
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const json = await res.json();
    if(json.items){ itemsMap = {}; for(const item of json.items){ if(item.id && item.name) itemsMap[item.id]=item.name; } try{ localStorage.setItem(LS_ITEMS_KEY,JSON.stringify(itemsMap)); } catch(e){} }
  } catch(e){ console.warn('Failed to fetch items:',e); }
}
function loadItemsCache(){ try{ const raw=localStorage.getItem(LS_ITEMS_KEY); if(!raw) return null; return JSON.parse(raw);}catch(e){return null;} }

// --- Display Name ---
function getDisplayName(id, product) {
  let name = itemsMap[id] || id;

  if (/^ENCHANTMENT_/i.test(name) || /^ENCHANTMENT_ULTIMATE_/i.test(name)) {
    // Special cases
    if (/^ENCHANTMENT_ULTIMATE_REITERATE_/i.test(name))
      return 'Duplex ' + (name.match(/_([0-9]+)$/)?.[1] || '');
    if (/^ENCHANTMENT_ULTIMATE_WISE_/i.test(name))
      return 'Ultimate Wise ' + (name.match(/_([0-9]+)$/)?.[1] || '');
    if (/^ENCHANTMENT_ULTIMATE_JERRY_/i.test(name))
      return 'Ultimate Jerry ' + (name.match(/_([0-9]+)$/)?.[1] || '');

    // Remove prefixes and underscores
    name = name
      .replace(/^ENCHANTMENT_ULTIMATE_/i, '')
      .replace(/^ENCHANTMENT_/i, '')
      .replace(/_/g, ' ')
      .trim();

    // Capitalize each word
    name = name
      .split(' ')
      .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
      .join(' ');
  } 
  else if (/^ESSENCE_/i.test(name)) {
    name = name
      .replace(/^ESSENCE_/i, '')
      .replace(/_/g, ' ')
      .trim();

    name = name
      .split(' ')
      .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
      .join(' ') + ' Essence';
  } 
  else {
    // General fallback
    name = name.replace(/_/g, ' ').trim();
    name = name
      .split(' ')
      .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
      .join(' ');
  }

  return name;
}


// --- Render Card with Expand ---
function makeCard(id, product){
  const el = document.createElement('div');
  el.className = 'card';
  const buy = getBuyPrice(product);
  const sell = getSellPrice(product);
  const vol = getVolume(product);
  const itemName = getDisplayName(id, product) || id;
  const npcSell = npcData[id] ?? null;

  el.innerHTML = `
    <div class="row">
      <div>
        <div class="id">${escapeHtml(itemName)}</div>
        <div class="muted-small">${escapeHtml(id)}</div>
      </div>
      <div style="text-align:right">
        <div class="price">${buy!==null?fmtNumber(buy):'—'}</div>
        <div class="muted-small">buy</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
      <div class="muted-small">sell: <strong>${sell!==null?fmtNumber(sell):'—'}</strong></div>
      <div class="muted-small">vol: <strong>${vol!==null?fmtNumber(vol):'—'}</strong></div>
      <div class="muted-small">npc: <strong>${npcSell!==null?fmtNumber(npcSell):'—'}</strong></div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="small raw-toggle">Raw</button>
        <button class="small copy-json">Copy</button>
      </div>
    </div>
    <pre class="json"></pre>
    <div class="order-book" style="
      overflow:hidden; 
      max-height:0; 
      transition:max-height 0.3s ease; 
      display:flex; 
      gap:20px; 
      margin-top:10px;
      font-size:13px;
      line-height:1.3;">
      <div class="buy-orders" style="flex:1"></div>
      <div class="sell-orders" style="flex:1"></div>
    </div>
  `;

  const raw = el.querySelector('.json');
  raw.textContent = JSON.stringify(product,null,2);

el.querySelector('.raw-toggle').addEventListener('click',(e)=>{ 
  e.stopPropagation(); // prevent card click
  raw.style.display = raw.style.display==='block'?'none':'block'; 
});
el.querySelector('.copy-json').addEventListener('click',async(e)=>{
  e.stopPropagation(); // prevent card click
  try{ 
    await navigator.clipboard.writeText(JSON.stringify(product,null,2)); 
    flashButtonMessage(el.querySelector('.copy-json'),'Copied'); 
  } catch(e){ 
    flashButtonMessage(el.querySelector('.copy-json'),'Fail'); 
  }
});

  // Click to expand order book
  el.addEventListener('click', ()=>{
    const ob = el.querySelector('.order-book');
    const buyDiv = el.querySelector('.buy-orders');
    const sellDiv = el.querySelector('.sell-orders');

    if(ob.style.maxHeight !== '0px' && ob.style.maxHeight !== ''){
      ob.style.maxHeight = '0';
    } else {
      // Fill Buy Orders (Table)
      if(product.buy_summary && product.buy_summary.length){
        buyDiv.innerHTML = `
          <table style="width:100%; border-collapse:collapse; text-align:right;">
            <thead>
              <tr>
                <th style="border-bottom:1px solid rgba(255,255,255,0.3); padding:2px 4px;">Price</th>
                <th style="border-bottom:1px solid rgba(255,255,255,0.3); padding:2px 4px;">Amount</th>
              </tr>
            </thead>
            <tbody>
              ${product.buy_summary.map(o=>`
                <tr>
                  <td style="border-bottom:1px solid rgba(255,255,255,0.1); padding:2px 4px;">${fmtNumber(o.pricePerUnit)}</td>
                  <td style="border-bottom:1px solid rgba(255,255,255,0.1); padding:2px 4px;">${fmtNumber(o.amount)}</td>
                </tr>`).join('')}
            </tbody>
          </table>`;
      } else buyDiv.innerHTML = '<em>No buy orders</em>';

      // Fill Sell Orders (Table)
      if(product.sell_summary && product.sell_summary.length){
        sellDiv.innerHTML = `
          <table style="width:100%; border-collapse:collapse; text-align:right;">
            <thead>
              <tr>
                <th style="border-bottom:1px solid rgba(255,255,255,0.3); padding:2px 4px;">Price</th>
                <th style="border-bottom:1px solid rgba(255,255,255,0.3); padding:2px 4px;">Amount</th>
              </tr>
            </thead>
            <tbody>
              ${product.sell_summary.map(o=>`
                <tr>
                  <td style="border-bottom:1px solid rgba(255,255,255,0.1); padding:2px 4px;">${fmtNumber(o.pricePerUnit)}</td>
                  <td style="border-bottom:1px solid rgba(255,255,255,0.1); padding:2px 4px;">${fmtNumber(o.amount)}</td>
                </tr>`).join('')}
            </tbody>
          </table>`;
      } else sellDiv.innerHTML = '<em>No sell orders</em>';

      ob.style.maxHeight = ob.scrollHeight + 'px'; // trigger transition
    }
  });

  return el;
}


// --- Render Products ---
function renderProducts(productsObj){
  const q=(qInput.value||'').trim().toLowerCase();
  const sortBy=sortSelect.value;
  const entries=Object.entries(productsObj||{});
  lastResponse=productsObj;

  let list = entries
    .map(([id,p]) => ({ id, product: p, itemName: getDisplayName(id,p)||id }))
    .filter(({id, product, itemName}) => {
      if (id === 'BAZAAR_COOKIE') return false;
      if (!q) return true;
      return id.toLowerCase().includes(q)
          || (product.product_id && product.product_id.toLowerCase().includes(q))
          || itemName.toLowerCase().includes(q);
    });

list.sort((a, b) => {
  const sortBy = sortSelect.value;
  let res = 0;

  if (sortBy === 'id') {
    res = a.id.localeCompare(b.id);
  } else if (sortBy === 'buy') {
    res = (getBuyPrice(a.product) || 0) - (getBuyPrice(b.product) || 0);
  } else if (sortBy === 'sell') {
    res = (getSellPrice(a.product) || 0) - (getSellPrice(b.product) || 0);
  } else if (sortBy === 'volume') {
    res = (getVolume(a.product) || 0) - (getVolume(b.product) || 0);
  } else if (sortBy === 'npc') {
    res = (a.product.sellPriceMin || 0) - (b.product.sellPriceMin || 0);
  }

  return ascending ? res : -res; // apply ascending/descending
});

  const pageSize=DEFAULT_PAGE_SIZE;
  const slice=list.slice(0,pageSize);
  listEl.innerHTML='';
  for(const item of slice){ listEl.appendChild(makeCard(item.id,item.product)); }

  countEl.textContent = slice.length;
  cachedEl.textContent = hasCache()?'yes':'no';
}

// --- Fetch Bazaar ---
async function fetchBazaar(){
  const url=buildUrl();
  try{
    refreshBtn.disabled=true; refreshBtn.textContent='Loading...';
    const res=await fetch(url,{cache:'no-store'});
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    const json=await res.json();
    if(json.success && json.products){ 
      saveCache(json.products); 
      lastUpdatedEl.textContent=new Date().toLocaleTimeString();
      renderProducts(json.products);
    }
  }catch(e){ console.warn('Failed to fetch bazaar:',e); }
  finally{ refreshBtn.disabled=false; refreshBtn.textContent='Refresh'; }
}

// --- Cache ---
function saveCache(data){ try{ localStorage.setItem(LS_KEY,JSON.stringify(data)); } catch(e){} }
function loadCache(){ try{ const raw=localStorage.getItem(LS_KEY); return raw?JSON.parse(raw):null; } catch(e){return null;} }
function hasCache(){ return !!localStorage.getItem(LS_KEY); }

// --- Settings modal events ---
settingsBtn.addEventListener('click', ()=>{ settingsModal.style.display='flex'; });
modalClose.addEventListener('click', ()=>{ settingsModal.style.display='none'; });

modalAutoRefresh.addEventListener('change', ()=>{
  const checked = modalAutoRefresh.checked;
  localStorage.setItem('autoRefresh', checked);
  if(checked){
    const sec = parseInt(modalInterval.value)||30;
    autoTimer = setInterval(fetchBazaar, sec*1000);
  } else { clearInterval(autoTimer); autoTimer=null; }
});

modalInterval.addEventListener('change', ()=>{
  const sec = parseInt(modalInterval.value)||30;
  localStorage.setItem('autoRefreshInterval', sec);
  if(modalAutoRefresh.checked){
    clearInterval(autoTimer);
    autoTimer = setInterval(fetchBazaar, sec*1000);
  }
});

simplifyNumbersCb.addEventListener('change', ()=>{
  localStorage.setItem('simplifyNumbers', simplifyNumbersCb.checked);
  if(lastResponse) renderProducts(lastResponse);
});

// --- Other events ---
refreshBtn.addEventListener('click', fetchBazaar);
qInput.addEventListener('input', ()=>{ if(lastResponse) renderProducts(lastResponse); });
sortSelect.addEventListener('change', ()=>{ if(lastResponse) renderProducts(lastResponse); });

// --- Init ---
(async()=>{
  await fetchItems();
  await fetchNpcPrices();
  const cached=loadCache();
  if(cached){ lastUpdatedEl.textContent='(cached)'; renderProducts(cached); }
  fetchBazaar();

  // Start auto-refresh if enabled
  if(modalAutoRefresh.checked){
    const sec = parseInt(modalInterval.value)||30;
    autoTimer = setInterval(fetchBazaar, sec*1000);
  }
})();
const root = document.documentElement;
const colorPickers = [
  {id: 'bgPicker', var: '--bg'},
  {id: 'cardPicker', var: '--card'},
  {id: 'mutedPicker', var: '--muted'},
  {id: 'accentPicker', var: '--accent'},
  {id: 'textPicker', var: '--text'},
];

// Load saved values and apply them immediately
colorPickers.forEach(picker => {
  const input = document.getElementById(picker.id);
  const saved = localStorage.getItem(picker.var);
  if(saved){
    input.value = saved;
    root.style.setProperty(picker.var, saved);
  }
});

// Apply button: only update changed values
document.getElementById('applyColors').addEventListener('click', () => {
  colorPickers.forEach(picker => {
    const input = document.getElementById(picker.id);
    const val = input.value.trim();
    const currentVal = getComputedStyle(root).getPropertyValue(picker.var).trim();

    if(isValidColor(val)){
      if(val !== currentVal){
        root.style.setProperty(picker.var, val);
        localStorage.setItem(picker.var, val);
      }
      input.style.borderColor = ''; // reset border
    } else {
      input.style.borderColor = 'red'; // invalid input
    }
  });
});

// Validate CSS color
function isValidColor(strColor){
  const s = new Option().style;
  s.color = strColor;
  return s.color !== '';
}

// Settings modal open/close logic (example)
document.getElementById('closeSettings').addEventListener('click', () => {
  document.getElementById('settingsModal').style.display = 'none';
});

// Example: open modal (hook to your button)
document.getElementById('openSettings')?.addEventListener('click', () => {
  document.getElementById('settingsModal').style.display = 'flex';
});

const defaultColors = {
  '--bg': '#0f1724',
  '--card': '#0b1220',
  '--muted': '#94a3b8',
  '--accent': '#60a5fa',
  '--glass': 'rgba(255,255,255,0.03)',
  '--text': '#ffffff'
};


document.getElementById('resetColors').addEventListener('click', () => {
  for (const [varName, value] of Object.entries(defaultColors)) {
    root.style.setProperty(varName, value);
    localStorage.removeItem(varName);

    // Optional: update linked inputs
    const input = document.querySelector(`[data-var="${varName}"]`);
    if(input) input.value = value;
  }
});

</script>
</body>
</html>
